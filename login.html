<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KS Veg Login</title>
    <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, textarea { width: 100%; margin: 8px 0; padding: 8px; }
    input{ 
      color: green;
      border: black;
    }
    button {
      background-color: rgb(58, 255, 58);
      color: white;

    }
    
  button:hover {
  background: #33ff5f;
    transform: translateY(-4px) scale(1.05); 
    box-shadow: 0 10px 20px rgb(255, 255, 255)
  
}
h2 {
   color: #ffffff;               /* green */
    text-shadow: 0px 0px 10px white, 0px 0px 20px white;
    animation: fadeInOut 3s infinite;
}
label {
  font-weight: bold;
  color: rgb(100, 255, 69);
}
    
  </style>
   <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div id="askaccount">
    <br><br>
    <h2>Do you have account ?</h2>
    <button onclick="yes()">Yes</button>
    <button onclick="no()">No</button><br><br><br><br><br><br><br>
    
    <label > *[To login, press YES</label><br>
    <label>To Register, press NO]</label>
  </div>
  <div id="afterconform" style="display: none;">
  <h2 id="loginhead">Customer Login</h2>

  <label for="mobile">Mobile Number:</label>
  <input type="text" id="mobile" placeholder="Enter mobile number" />

  <label for="password">Password:</label>
  <input type="password" id="password" placeholder="Enter 6-digit password" />

  <button id="loginbtn" onclick="loginUser()">Login</button>
  <button id="registerbtn" onclick="registerUser()" style="display: none;" >Register</button>
</div>
  <div id="stepDetails" style="display:none;">
    <label for="name">Name:</label>
    <input type="text" id="name" placeholder="Enter your name" />
    <label for="address">Address:</label>
    <textarea id="address" placeholder="Enter your address"></textarea>
    <button onclick="saveDetails()">Save Details</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // üîë Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAXOY6MTSvCosLY4oSxjLqpZ6qLUPhifGU",
      authDomain: "ksvegetables-3959d.firebaseapp.com",
      projectId: "ksvegetables-3959d",
      storageBucket: "ksvegetables-3959d.firebasestorage.app",
      messagingSenderId: "791132153293",
      appId: "1:791132153293:web:2fb8a42dd2262fd48b9084"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

  
    // ‚úÖ Register User
    function registerUser() {
      const mobile = document.getElementById("mobile").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!/^[0-9]{10}$/.test(mobile)) {
        alert("‚ö†Ô∏è Enter valid 10-digit mobile");
        return;
      }
       if (mobile === "" || mobile.length !== 10 || isNaN(mobile)) {
    alert("‚ö†Ô∏è Please enter a valid 10-digit mobile number!");
    return;
  }
  
  // ‚úÖ Validate password
  if (password.length ===0) {
    alert("Please enter 6-digit password!");
    return;
  }
  if (password.length !== 6 || isNaN(password)) {
    alert("‚ö†Ô∏è Password must be exactly 6 digits!");
    return;
  }


      const fakeEmail = mobile + "@ksveg.com";

      firebase.auth().createUserWithEmailAndPassword(fakeEmail, password)
        .then(userCredential => {
          const user = userCredential.user;

          // save minimal details first
          return db.collection("users").doc(user.uid).set({
            phone: mobile,
            name: "",
            address: ""
          });
        })
        .then(() => {
          alert("‚úÖYour mobile number is registered successfully! Please add your details.");
          document.getElementById("stepDetails").style.display = "block";
        })
        .catch(error => {
          alert("‚ùå Registration failed: " + error.message);
        });
    }

    // ‚úÖ Login User
function loginUser() {
  const mobile = document.getElementById("mobile").value.trim();
  const password = document.getElementById("password").value.trim();
  const fakeEmail = mobile + "@ksveg.com";

  // ‚úÖ Validate mobile
  if (mobile === "" || mobile.length !== 10 || isNaN(mobile)) {
    alert("‚ö†Ô∏è Please enter a valid 10-digit mobile number!");
    return;
  }

  // ‚úÖ Validate password
  if (password.length !== 6 || isNaN(password)) {
    alert("‚ö†Ô∏è Password must be exactly 6 digits!");
    return;
  }

  // üîê Login
  firebase.auth().signInWithEmailAndPassword(fakeEmail, password)
    .then(userCredential => {
      const user = userCredential.user;
      return db.collection("users").doc(user.uid).get();
    })
    .then(doc => {
      if (doc.exists) {
    const data = doc.data();
    localStorage.setItem("customerName", data.name);
    localStorage.setItem("customerMobile", data.phone);
    localStorage.setItem("customerAddress", data.address);

    // Set role
    let role = "customer";
    if(data.phone === "9655723110") {
        role = "admin";
    }
    localStorage.setItem("userRole", role);
    localStorage.setItem("isLoggedIn", "true");

    alert("üéâ Welcome " + data.name + "! ");

    // ‚úÖ Update parent page UI
    window.parent.setLogin();
    window.parent.updateLoginStatus();
    window.parent.closePopup();

    // ‚úÖ Redirect based on role
    if(role === "admin") {
        window.parent.location.href = "admin.html";
    } else {
        window.parent.location.href = "index.html";
    }
}

    
    })
  
    .catch(error => {
      console.error("Login failed:", error.code, error.message);

      if (error.code === "auth/user-not-found") {
        alert("üìå This mobile number is not registered. Please register first!");
        document.getElementById("loginhead").textContent = "Customer Register";
        document.getElementById("loginbtn").style.display = "none";
        document.getElementById("registerbtn").style.display = "block";
      } else if (error.code === "auth/wrong-password" || error.message.includes("INVALID_LOGIN_CREDENTIALS")) {
        alert("‚ùå Wrong mobile number or password. Try again.");
      } else {
        alert("‚ùå Login failed: " + error.message);
      }
    });
}

function yes() {
  alert("Please Login your account!");
  document.getElementById("askaccount").style.display="none";
  document.getElementById("afterconform").style.display="block";
}
function no() {
  alert("Please Register your account first!");
  document.getElementById("askaccount").style.display="none";
  document.getElementById("afterconform").style.display="block";
   document.getElementById("loginhead").textContent = "Customer Register";
        document.getElementById("loginbtn").style.display = "none";
        document.getElementById("registerbtn").style.display = "block";

}
    // ‚úÖ Save Details (after registration)
    function saveDetails() {
      const name = document.getElementById("name").value.trim();
      const address = document.getElementById("address").value.trim();
      const user = firebase.auth().currentUser;

      if (!user) {
        alert("‚ö†Ô∏è No logged-in user");
        return;
      }

      if (!name || !address) {
        alert("‚ö†Ô∏è Fill all details");
        return;
      }

      db.collection("users").doc(user.uid).update({
        name: name,
        address: address
      }).then(() => {
        localStorage.setItem("customerName", name);
        localStorage.setItem("customerMobile", user.email.split("@")[0]); // phone from email
        localStorage.setItem("customerAddress", address);
        alert("‚úÖ Details saved successfully! You can now order vegetables now!");
        window.parent.closePopup();
         window.parent.setLogin();
    // Update navbar icon on parent page
    window.parent.updateLoginStatus();
        window.parent.location.href = "index.html";
      }).catch(error => {
        alert("‚ùå Error saving details: " + error.message);
      });
    }
  </script>
</body>
</html>

